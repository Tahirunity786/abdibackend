{% extends "base/base.html" %}
{% load static %}
{% block optionalcss %}
<link rel="stylesheet" href="{% static 'css/owl.carousel.min.css' %}">
<link rel="stylesheet" href="{% static 'css/owl.theme.default.min.css' %}">
{% endblock optionalcss %}
{% block title %}Profile{% endblock title %}
{% block content %}

    <main class="container">
        <div class="row">
            <div class="col-lg-4 mt-5">
                <form action="/hospitrack/user/pic/update" method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                <div class="cam-div">
                    <label for="pEFP" id="cmdbtn" role="button">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                             class="bi bi-camera-fill" viewBox="0 0 16 16">
                            <path d="M10.5 8.5a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0"></path>
                            <path
                                    d="M2 4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2h-1.172a2 2 0 0 1-1.414-.586l-.828-.828A2 2 0 0 0 9.172 2H6.828a2 2 0 0 0-1.414.586l-.828.828A2 2 0 0 1 3.172 4zm.5 2a.5.5 0 1 1 0-1 .5.5 0 0 1 0 1m9 2.5a3.5 3.5 0 1 1-7 0 3.5 3.5 0 0 1 7 0">
                            </path>
                        </svg>
                        <input type="file" id="pEFP" name="pic" style="display:none;" accept="image/*">
                    </label>
                </div>
                    <div style="width: 250px; height: 270px;">
                        {% if user_data.profile %}
                        <img id="image-preview" class="rounded-2 bg-body" src="/media/{{user_data.profile}}" style="height: 100%; width: 100%;"  alt="img">
                        {% else %}
                        <img id="image-preview" class="rounded-2 bg-body" src="https://dummyimage.com/270x250/000/fff" style="height: 100%; width: 100%;"  alt="img">
                        {% endif %}
                    </div>



                <h3 class="mt-4">{{user_data.first_name}} {{user_data.last_name}}</h3>
                <p>{% if user_data.email %} {{ user_data.email }} {% else %} Please update your email{% endif %}</p>
                <p>{% if user_data.date_of_birth %} {{ user_data.date_of_birth }} {% else %} Please update your birthday{% endif %}</p>
            <div class="w-100 h-100 ">
                <button type="submit" class="btn btn-primary m-auto">Update</button>
            </div>
        </form>
            </div>
            <div class="col-lg-8">
                {% for message in messages  %} 
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    <strong>Message : </strong> {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                  </div>
                {% endfor %}    
                <div class="row mt-5 link-sec owl-carousel owl-theme">
                    <div class="col">
                        <a href="#" class="ac-btn p-1" id="account">Account Setting</a>
                    </div>
                    <div class="col">
                        <a href="#" class="ac-btn p-1" id="profile">Profile Setting</a>
                        
                    </div>
                    {% if request.user.account_type == "Patient" %}
                    <div class="col">
                        <a href="#" class="ac-btn p-1" id="bed-reserve">Reservations</a>
                    </div>
                    {% elif request.user.account_type == "Doctor" %}
                    <div class="col">
                        <a href="#" class="ac-btn p-1" id="bed-reserve">New Appointments</a>
                    </div>
                    
                    {% endif %}
                
                    <div class="col">
                        <a href="#" class="ac-btn p-1" id="dc-appoint">Appointments</a>
                    </div>
                    <div class="col">
                        <a href="#" class="ac-btn p-1" id="cont">Contact</a>
                    </div>
                </div>

                <!-- Account Setting -->

                <div id="account-setting" style="display: block;" class="mt-3 ms-1">
                    <h2>Account Setting</h2>

                    <form method="post" action="/hospitrack/user/profile/pass/update">
                        {% csrf_token %}
                        <div class="mb-2 mt-2">
                            <label for="exampleInputPassword1" class="form-label">Previous Password*</label>
                            <input type="password" name="prepass" class="form-control ac-inp" id="exampleInputPassword1">
                           
                        </div>
                        <div class="mb-2">
                            <label for="exampleInputPassword2" class="form-label">New Password*</label>
                            <input type="password" name="newpass" class="form-control ac-inp" id="exampleInputPassword2">
                        </div>
                        <div class="mb-2">
                            <label for="exampleInputPassword3" class="form-label">Confirm Password*</label>
                            <input type="password" name="confirmpass" class="form-control ac-inp" id="exampleInputPassword3">
                        </div>

                        <button type="submit" class="btn mt-2 u-btn">Update</button>
                    </form>
                </div>

                <!-- Profile Setting -->
                <div id="profile-setting" style="display: none;" class="mt-2">
                    <h2>Profile Setting</h2>

                    <form method="post" action="/hospitrack/user/profile/update">
                        {% csrf_token %}
                        <div class="row mt-3 r-sec" style="padding-right: 0px;">
                            <div class="col-lg-6">
                                <label for="firstName" class="form-label">First Name</label>
                                <input type="text" class="form-control p-inp1" name="firstname" id="firstName" placeholder="{% if  user_data.first_name %} {{ user_data.first_name }} {% else %} Please add your firstName {% endif %}">


                            </div>
                            <div class="col-lg-6">
                                <label for="lastName" class="form-label">Last Name</label>
                                <input type="text" class="form-control p-inp1" name="lastname" id="lastName"  placeholder="{% if user_data.last_name %} {{ user_data.last_name }} {% else %} Please add your lastname{% endif %}">

                            </div>
                        </div>
                        <div class="mt-3">
                            <label for="userName" class="form-label">Username</label>
                            <input type="text" class="form-control p-inp2" name="username" id="userName" placeholder="{% if user_data.username %} {{ user_data.username }} {% else %} Please add your Username{% endif %}"
                            > 
                        </div>
                        <div class="mt-3">
                            <label for="exampleInputEmail1" class="form-label">Email address</label>
                            <input type="email" class="form-control p-inp2" name="email"  id="exampleInputEmail1"
                                aria-describedby="emailHelp" placeholder="{% if user_data.email %} {{ user_data.email }} {% else %} Please add your email{% endif %}">

                        </div>
                        <div class="mt-3">
                            <label for="Birthday" class="form-label">Birthday</label>
                            <input type="date" name="birthday" class="form-control p-inp2" id="Birthday">
                        </div>
                        {% if request.user.account_type == "Doctor" %}
                        <div class="row mt-4">
                            <h3 class="mb-3">Showcase your work</h3>
                            <div class="col-lg-6 col-md-6 col-sm-12">
                                <div class="mb-3">
                                  <label for="Experiece" class="form-label">Add Experience</label>
                                  <textarea class="form-control" name="exp" id="Experiece" placeholder="I have 3 years of experience" style="resize: none;" rows="3"></textarea>
                                </div>
                            </div>
                            <div class="col-lg-6 col-md-6 col-sm-12">
                                <div class="mb-3">
                                  <label for="Education" class="form-label">Add Education</label>
                                  <textarea class="form-control" name="edu" id="Education" placeholder="I'm MBBS graduated" style="resize: none;" rows="3"></textarea>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="Certificate" class="form-label">Add Certificate</label>
                                <textarea class="form-control" name="ac" id="Certificate" placeholder="I have won an award in my college" style="resize: none;" rows="5"></textarea>
                              </div>
                        </div>
                        {% endif %}
                        <button type="submit" class="btn mt-3 upd-profile">Submit</button>
                    </form>
                </div>
<!-- Bed Reservements -->

                <div id="bed-reservements" style="display: none;" class="mt-3">
                    {% if request.user.account_type == "Patient" %}
                    <h2 class="mb-3">Bed Reservements</h2>
                    {% if reservements and request.user.account_type == "Patient"  %}
                    {% for reservement in reservements %}
                    <table class="table">
                        <thead>
                          <tr>
                            <th scope="col">#</th>
                            <th scope="col">Room no</th>
                            <th scope="col">Bed no</th>
                            <th scope="col">Day</th>
                            
                            <th scope="col">Reason</th>
                            <th scope="col">status</th>
                         
                          </tr>
                        </thead>
                        <tbody>
                            {% for re in bed_reservation %}
                            {% comment %} {% if re.status == "Reserve" %} {% endcomment %}
                          <tr>
                            <th scope="row">{{forloop.counter}}</th>
                            <td>{{re.room_no}}</td>
                            <td>{{re.bed_no}}</td>
                            <td>{{re.date_created}}</td>
                          
                            <td> <button class="border-0 view-res" style="background-color: transparent;" data-id="{{ re.id }}" data-bs-toggle="modal" data-bs-target="#res">
                                <span class="badge bg-primary rounded-circle ms-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-eye-fill" viewBox="0 0 16 16">
                                        <path d="M10.5 8a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0"/>
                                        <path d="M0 8s3-5.5 8-5.5S16 8 16 8s-3 5.5-8 5.5S0 8 0 8m8 3.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7"/>
                                    </svg>
                                </span>
                            </button></td>
                            {% if re.reservation.status == "Pending" %}
                            <td><span class="badge text-bg-warning">Pending</span></td>
                            {% elif re.reservation.status == "Reserve" %}
                            <td><span class="badge text-bg-success">Reserved</span></td>
                            {% elif re.reservation.status == "Decline" %} 
                            <td><span class="badge text-bg-danger">Declined</span></td>
                            {% endif %}
                            
                          </tr>
                          {% comment %} {% endif %} {% endcomment %}
                          {% endfor %}
                        </tbody>
                    </table>
                    {% endfor %}
                    {% else %}
                    <h5 style="opacity: 0.5;">Your Bed Reservements will show here</h5>

                    
                    {% endif %}
                    {% elif request.user.account_type == "Doctor"  %}
                    {% if docappoint %}
                    <table class="table">
                        <thead>
                          <tr>
                            <th scope="col">#</th>
                            <th scope="col">Patient</th>
                            <th scope="col">Doctor</th>
                            <th scope="col">Phone no</th>
                            <th scope="col">Day</th>
                            <th scope="col">Reason</th>
                            <th scope="col">status</th>
                            <th scope="col">Accept</th>
                            <th scope="col">Decline</th>
                          </tr>
                        </thead>
                        <tbody>
                            {% for doc in docappoint %}
                            {% if doc.status == "Pending" %}
                          <tr>
                            <th scope="row">{{doc.id}}</th>
                            <td>{{doc.user.first_name}}</td>
                            <td>{{doc.doctor_user.first_name}}</td>
                            <td>{{doc.phone_no}}</td>
                            <td>{{doc.scheduled_day}}</td>
                            <td> <button class="border-0 view-reason" style="background-color: transparent;" data-id="{{ doc.id }}" data-bs-toggle="modal" data-bs-target="#doc">
                                <span class="badge bg-primary rounded-circle ms-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-eye-fill" viewBox="0 0 16 16">
                                        <path d="M10.5 8a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0"/>
                                        <path d="M0 8s3-5.5 8-5.5S16 8 16 8s-3 5.5-8 5.5S0 8 0 8m8 3.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7"/>
                                    </svg>
                                </span>
                            </button></td>
                            <td><span class="badge text-bg-warning">Pending</span></td>
                            <td><a href="/hospitrack/appointment-accept/{{doc.id}}/" style="background-color: blue; color: white; border: none; outline: none; padding-left: 10px; padding-right: 10px; padding-bottom: 5px; border-radius: 10px;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-check-lg" viewBox="0 0 16 16">
                                    <path d="M12.736 3.97a.733.733 0 0 1 1.047 0c.286.289.29.756.01 1.05L7.88 12.01a.733.733 0 0 1-1.065.02L3.217 8.384a.757.757 0 0 1 0-1.06.733.733 0 0 1 1.047 0l3.052 3.093 5.4-6.425z"/>
                                  </svg>
                                </a></td>
                            <td><a href="/hospitrack/appointment-decline/{{doc.id}}/" style="background-color: red; color: white; border: none; outline: none; padding-left: 10px; padding-right: 10px; padding-bottom: 5px; border-radius: 10px;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-x-lg" viewBox="0 0 16 16">
                                    <path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8z"/>
                                  </svg>
                                </a></td>
                            
                          </tr>
                          {% endif %}
                          {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <h5>You will appointments here</h5>
                    {% endif %}
                    {% endif %}

                </div>

<!-- Doctor Appointments -->
                <div id="doc-appointments" style="display: none;" class="mt-3">
                    <h2 class="mb-3">Doctor Appointments</h2>
                    {% if request.user.account_type == "Patient" %}
                {% if doc_app %}
                    {% for appointment in doc_app %}
                        <div class="d-flex justify-content-between align-items-center mt-2 bg-light p-3 rounded" data-id="9">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    {% if appointment.doctor.profile.url %}
                                        <img src="/media/{{ appointment.doctor.profile.url }}" alt="Doctor Image" class="rounded-circle" height="60px" width="60px" style="object-fit: cover;">
                                    {% else %}
                                        <img src="https://dummyimage.com/60x60/4f4d4f/fff" alt="Placeholder Image" class="rounded-circle" height="60px" width="60px" style="object-fit: cover;">
                                    {% endif %}
                                </div>
                                <div class="details ms-3">
                                    <h6 style="margin-bottom: 5px !important;">{{ appointment.doctor_user.first_name }}</h6>
                                    <p style="margin-bottom: 0px !important;">Reason from you: <b>{{ appointment.reason }}</b></p>
                                </div>
                            </div>
                            {% if appointment.reservation.status == "Pending" %}
    <span class="badge text-bg-primary">Pending</span>
{% elif appointment.reservation.status == "Ok" %}
    <span class="badge text-bg-success">Accepted</span>
{% elif appointment.reservation.status == "Decline" %}
<span class="badge text-bg-danger">Declined</span> 
{% endif %}

                        </div>
                    {% endfor %}
                {% else %}
                    <h5 style="opacity: 0.5;">Your appointments will show here</h5>
                {% endif %}
            {% elif request.user.account_type == "Doctor" %}
            {% for doctorsapp in done_appoints %}
            <div class="d-flex justify-content-between align-items-center mt-2 bg-light p-3 rounded" data-id="9">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        {% if doctorsapp.doctor_user.profile %}
                            <img src="/media/{{ doctorsapp.doctor_user.profile }}" alt="Doctor Image" class="rounded-circle" height="60px" width="60px" style="object-fit: cover;">
                        {% else %}
                            <img src="https://dummyimage.com/60x60/4f4d4f/fff" alt="Placeholder Image" class="rounded-circle" height="60px" width="60px" style="object-fit: cover;">
                        {% endif %}
                    </div>
                    <div class="details ms-3">
                        <h6 style="margin-bottom: 5px !important;">{{ doctorsapp.user.first_name }}</h6>
                        <p style="margin-bottom: 0px !important;">User Reason: {{ doctorsapp.reason }}</p>
                    </div>

                </div>
                {% if doctorsapp.status == "Ok" %}
                <span class="badge rounded-pill text-bg-success">Accepted</span>
                {% elif doctorsapp.status == "Decline" %}
                <span class="badge rounded-pill text-bg-danger">Declined</span>
                {% endif %}
            </div>
                {% endfor %}
            {% endif %}
            
            </div>
{% comment %} Contact Section {% endcomment %}
                <div id="contact" style="display: none;" class="mt-3">
                    <h2 class="mb-3">Contact</h2>
                                    {% for contact in contacts %}
                    <div class="d-flex justify-content-between align-items-center mt-2 bg-light p-3  rounded"
                        data-id="9">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="d-flex justify-content-between align-items-center">
                                    {% if request.user.User.profile.url %}
                                <img src="/media/{{request.user.User.profile.url}}" alt="image" class="rounded-circle"
                                    height="60px" width="60px" style="object-fit: cover;">
                                    {% else %}
                                    <img src="https://dummyimage.com/60x60/4f4d4f/fff" alt="image" class="rounded-circle"
                                    height="60px" width="60px" style="object-fit: cover;">
                                    {% endif %}
                                    
                            </div>
                            <div class="details ms-3">
                                <h6 style="margin-bottom: 5px !important;">Ticket no# {{contact.contact_ticket}}</h6>
                                <p style="margin-bottom: 0px !important;">{{contact.message}}</p>
                            </div>
                            
                        </div>
                        {% if contact.status == "Pending" %}
                        <div>
                            <span class="badge rounded-pill text-bg-warning">Pending</span>
                        </div>
                        {% elif contact.status == "Solved" %}
                        <div>
                            <span class="badge rounded-pill text-bg-success">Solved</span>
                        </div>
                        {% endif %}
                </div>

                {% endfor %}
            </div>


        </div>
    </main>

    <div class="modal fade" id="doc" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h1 class="modal-title fs-5" id="reasontitle"></h1>
              
            </div>
            <div class="modal-body" id="reasonbody">
             
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              
            </div>
          </div>
        </div>
      </div>
    <div class="modal fade" id="res" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h1 class="modal-title fs-5" id="restitle"></h1>
              
            </div>
            <div class="modal-body" id="resbody">
             
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              
            </div>
          </div>
        </div>
      </div>
    {% endblock content %}

    
    {% block optionaljs %}
    <script src="{% static 'js/owl.carousel.min.js' %}"></script>
    <script src="{% static 'js/brain.js' %}"></script>
    {% endblock optionaljs %}

    {% block js %} 
    document.addEventListener("DOMContentLoaded", function() {
        var viewButtons = document.querySelectorAll('.view-res');
        const title = document.getElementById("restitle");
        const bodyv = document.getElementById("resbody");
        viewButtons.forEach(function(button) {
            button.addEventListener('click', function() {
                var bed_id = this.getAttribute('data-id');
                var xhr = new XMLHttpRequest();
                xhr.open('POST', '/controller/bed-viewer/', true);
                xhr.setRequestHeader('Content-Type', 'application/json');
                xhr.setRequestHeader('X-CSRFToken', getCookie('csrftoken'));
                xhr.onreadystatechange = function() {
                    if (xhr.readyState === XMLHttpRequest.DONE) {
                        if (xhr.status === 200) {
                            
                            var responseData = JSON.parse(xhr.responseText);
                            console.log(responseData)
                            title.innerText = `${responseData.bedno}#`;
                            bodyv.innerHTML = `
                                  <h4>Reason: Why you want to reserve bed?</h4>
                                  <p>Reason : ${responseData.reason}</p>
                                  
                                `;
                        } else {
                            console.error(xhr.status + ': ' + xhr.responseText);
                            // Handle error
                        }
                    }
                };
                xhr.send(JSON.stringify({ 'bed_id': bed_id }));
            });
        });
    });
    
    // Function to get CSRF token from cookies
    function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
        $('.owl-carousel').owlCarousel({
            loop: true,
            margin: 10,
            responsiveClass: true,
            nav: false,
            responsive: {
                0: {
                    items: 2,
                    nav: true
                },
                400: {
                    items: 3,
                    nav: false
                },
                575: {
                    items: 3,
                    nav: false
                },
                767: {
                    items: 3,
                    nav: false
                },
                900: {
                    items: 3,
                    nav: false
                },
                992: {
                    items: 4,
                    nav: true,
                    loop: false
                },
                1000: {
                    items: 5,
                    nav: true,
                    loop: false
                }
            }
        });
        document.getElementById('pEFP').addEventListener('change', function(event) {
            const file = event.target.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('image-preview').src = e.target.result;
            };
            reader.readAsDataURL(file);
        });

        document.addEventListener("DOMContentLoaded", function() {
            var viewButtons = document.querySelectorAll('.view-reason');
            const title = document.getElementById("reasontitle");
            const bodyv = document.getElementById("reasonbody");
            viewButtons.forEach(function(button) {
                button.addEventListener('click', function() {
                    var contactId = this.getAttribute('data-id');
                    var xhr = new XMLHttpRequest();
                    xhr.open('POST', '/hospitrack/appointment-gainer-user', true);
                    xhr.setRequestHeader('Content-Type', 'application/json');
                    xhr.setRequestHeader('X-CSRFToken', getCookie('csrftoken'));
                    xhr.onreadystatechange = function() {
                        if (xhr.readyState === XMLHttpRequest.DONE) {
                            if (xhr.status === 200) {
                                
                                var responseData = JSON.parse(xhr.responseText);
                                title.innerText = "Reason from Patient";
                                bodyv.innerHTML = `
                               <div class="container-fluid">
                                <div class="mb-3">
                                    <h3>Reaon details:</h3>
                                </div>
                                <p>${responseData.reason}</p>
                               </div>
                                `;
                            } else {
                                console.error(xhr.status + ': ' + xhr.responseText);
                                // Handle error
                            }
                        }
                    };
                    xhr.send(JSON.stringify({ 'app_id': contactId }));
                });
            });
        });
        
        // Function to get CSRF token from cookies
        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        {% endblock js %}